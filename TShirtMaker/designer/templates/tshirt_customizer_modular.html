{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>T-shirt Customizer - Modular</title>
  <!-- Dropzone CSS from CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/tshirt_customizer_modular.css' %}">
</head>
<body>
  <h1>T-shirt Customizer</h1>

  <!-- Clothing Variant Selection -->
  <div class="variant-selector">
    <label for="clothingVariant">Choose Clothing Variant:</label>
    <select id="clothingVariant">
      <option value="half_sleeve_black">Half Sleeve - Black</option>
      <option value="half_sleeve_white">Half Sleeve - White</option>
      <!-- Add more options as needed -->
    </select>
  </div>

  <!-- T-shirt Display Container -->
  <div class="tshirt-container">
    
    <!-- Front Section -->
    <div class="tshirt-section" id="section-front">
      <img class="base-image" id="front-base" src="" alt="Front T-shirt">
      <!-- Designated area for upload -->
      <div class="designated-area" id="front-dropzone">
         <div class="upload-placeholder">&#43;</div>
         <img class="overlay-image" id="front-overlay" src="" alt="Front Design" style="display:none;">
      </div>
    </div>

    <!-- Back Section -->
    <div class="tshirt-section" id="section-back">
      <img class="base-image" id="back-base" src="" alt="Back T-shirt">
      <div class="designated-area" id="back-dropzone">
         <div class="upload-placeholder">&#43;</div>
         <img class="overlay-image" id="back-overlay" src="" alt="Back Design" style="display:none;">
      </div>
    </div>

    <!-- Left Sleeve Section -->
    <div class="tshirt-section" id="section-leftSleeve">
      <img class="base-image" id="left-base" src="" alt="Left Sleeve T-shirt">
      <div class="designated-area" id="left-dropzone">
         <div class="upload-placeholder">&#43;</div>
         <img class="overlay-image" id="left-overlay" src="" alt="Left Sleeve Design" style="display:none;">
      </div>
    </div>

    <!-- Right Sleeve Section -->
    <div class="tshirt-section" id="section-rightSleeve">
      <img class="base-image" id="right-base" src="" alt="Right Sleeve T-shirt">
      <div class="designated-area" id="right-dropzone">
         <div class="upload-placeholder">&#43;</div>
         <img class="overlay-image" id="right-overlay" src="" alt="Right Sleeve Design" style="display:none;">
      </div>
    </div>
    
  </div>

  <!-- Load External Config -->
  <script src="{% static 'js/tshirtConfig.js' %}"></script>
  <!-- Dropzone JS from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
  <script>
    // Global variable to hold the current Dropzone instances so we can clear them on reinit if needed.
    let currentDropzones = [];

    // Initialize the customizer based on the selected variant configuration.
    function initializeCustomizer(configKey) {
      // Remove any previously created Dropzones
      currentDropzones.forEach(dz => dz.destroy());
      currentDropzones = [];

      // Get the configuration for the selected variant
      const config = tshirtConfigs[configKey];
      if (!config) {
        console.error("Configuration not found for key: " + configKey);
        return;
      }

      // For each section, update the base image and setup the designated area & Dropzone.
      Object.keys(config.sections).forEach(sectionKey => {
        const sectionConfig = config.sections[sectionKey];
        
        // Update base image src
        document.getElementById(sectionKey + "-base").src = sectionConfig.baseImage;
        
        // Configure the designated upload area
        const dropzoneElem = document.querySelector("#" + sectionKey + "-dropzone");
        dropzoneElem.style.position = "absolute";
        dropzoneElem.style.top = sectionConfig.designatedArea.top;
        dropzoneElem.style.left = sectionConfig.designatedArea.left;
        dropzoneElem.style.width = sectionConfig.designatedArea.width;
        dropzoneElem.style.height = sectionConfig.designatedArea.height;
        dropzoneElem.style.border = "2px dashed #fff";
        dropzoneElem.style.boxSizing = "border-box";
        dropzoneElem.style.pointerEvents = "auto";

        // Initialize Dropzone on the designated area
        const dz = new Dropzone("#" + sectionKey + "-dropzone", {
          url: sectionConfig.uploadEndpoint, // For future backend integration
          maxFiles: 1,
          acceptedFiles: "image/*",
          autoProcessQueue: false, // Demo mode; processes file locally
          clickable: dropzoneElem,
          previewsContainer: false, // Disable default preview element
          init: function() {
            this.on("addedfile", function(file) {
              // Hide any default preview element
              if (file.previewElement) {
                file.previewElement.style.display = "none";
              }
              // Process file via FileReader
              const reader = new FileReader();
              reader.onload = function(event) {
                const overlayImg = document.querySelector("#" + sectionKey + "-overlay");
                overlayImg.src = event.target.result;
                overlayImg.style.display = "block";
              };
              reader.readAsDataURL(file);
            });
          }
        });
        currentDropzones.push(dz);
      });
    }

    // When the page loads, initialize with the default selection.
    document.addEventListener("DOMContentLoaded", function() {
      const variantSelect = document.getElementById("clothingVariant");
      // Initialize with the currently selected variant
      initializeCustomizer(variantSelect.value);
      
      // On variant change, reinitialize the customizer.
      variantSelect.addEventListener("change", function() {
        initializeCustomizer(this.value);
      });
    });
  </script>
</body>
</html>
